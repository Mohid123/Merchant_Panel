<!-- begin::Row -->
<div class="flex flex-row flex-wrap justify-between w-full mb-5">
  <span class="text-3xl font-bold text-black">Analytics</span>
  <button data-kt-menu-trigger="click" class="px-6 py-3 text-sm font-thin text-white bg-blue-500 btn" [routerLink]="['/deals/create-deal']">Create a Deal</button>
</div>

<div class="flex justify-between flex-nowrap">
  <div class="first">
    <app-mixed-widget2
      class="card card-xl-stretch max-h-84"
      chartColor="danger"
      chartHeight="249px"
      strokeColor="#cb1e46"
    ></app-mixed-widget2>
  </div>

  <div>
    <app-mixed-widget10
      class="mb-4 card card-xxl-stretch-50 common-10"
      chartColor="#FFEBDC"
      chartHeight="190px"
      chartWidth="100%"
    ></app-mixed-widget10>
    <app-mixed-widget11
      class="card card-xxl-stretch-50 common-10"
      chartColor="gray"
      chartHeight="190px"
      chartWidth="100%"
    ></app-mixed-widget11>
  </div>

  <div>
    <app-lists-widget5 class="card card-xxl-stretch common"></app-lists-widget5>
  </div>
</div>
<!-- end::Row -->

<div class="pb-4 pt-7">
  <span class="text-base font-semibold">Published Deals</span>
</div>


<ng-container *ngIf="showData == false">
  <app-table-skeleton></app-table-skeleton>
</ng-container>

<ng-container *ngIf="showData == true">
  <div class="mb-8 bg-white rounded-md shadow-sm table-container">
    <table class="w-full">
      <thead class="relative">
        <tr class="text-left text-gray-700 bg-white rounded-lg">
          <th class="py-4 font-semibold text-main pl-14">Deal ID &nbsp;</th>
          <th class="p-4 font-semibold text-main">Deal &nbsp;</th>
          <th class="font-semibold text-main" style="width: 200px; max-width: 200px;">Voucher sold</th>
          <th class="p-4 font-semibold text-main" style="max-width: 120px;">Average rating &nbsp;</th>
          <th class="font-semibold text-main" style="width: 100px; max-width: 200px;">Total net earnings</th>
        </tr>
        <div id="borderBottomMain"></div>
      </thead>
      <tbody class="relative">
       <ng-container *ngFor="let event of currentEvents; let index = index;"> <!--{{event.netEarnings.toFixed(2).replace('.', ',')}}-->
        <tr class="text-left text-gray-600 bg-white rounded-lg">
          <td class="py-4 text-left pl-14">{{event.dealID}}</td>
          <td class="p-4 text-left">
            <span class="cursor-pointer" *ngIf="event.dealHeader.length >= 22" [ngbTooltip]="event?.dealHeader" placement="top" [container]="'body'">{{(event.dealHeader.length > 22) ? ((event.dealHeader) | slice:0:22)+'...':(event.dealHeader)}}</span>
            <span *ngIf="event.dealHeader.length < 22">{{(event.dealHeader.length > 22) ? ((event.dealHeader) | slice:0:22)+'...':(event.dealHeader)}}</span>
          </td>
          <td style="padding-right: 105px;" class="text-right">{{event.soldVouchers}}</td>
          <td class="flex justify-start p-4 text-left">
            <bar-rating class="mb-2 star" [rate]="event.ratingsAverage" [max]="5" [readOnly]="true"></bar-rating>
            <span class="mt-1.5 ml-2">{{event.ratingsAverage.toFixed(1)}}</span>
          </td>
          <td style="width: 140px; padding-right: 5px;" class="text-right">{{event.netEarnings.toFixed(2).replace('.', ',')}} &euro;</td>
          <td class="flex justify-center px-8 py-4">
            <div style="all: unset" ngbDropdown placement="bottom">
              <i ngbDropdownToggle class="fas fa-ellipsis-h fa-sm p-1.5 bg-gray-100 rounded-md cursor-pointer mr-1.5"></i>
              <div class="z-50" ngbDropdownMenu aria-labelledby="dropdownBasic1">
                <a target="_blank" href="{{event?.dealPreviewURL}}" ngbDropdownItem class="flex justify-start px-3 my-2">
                  <img src="../../../../assets/media/icons/preview.svg" class="mt-1 mr-2">
                  <span class="text-sm text-gray-600">Preview</span>
                </a>
                <button ngbDropdownItem class="flex justify-start px-3 my-2" (click)="editDeal(index)">
                  <img src="../../../../assets/media/icons/editing.svg" class="mt-1 mr-2">
                  <span class="text-sm text-gray-600">Edit</span>
                </button> <!--(click)="editDeal(index)"-->
                <button ngbDropdownItem class="flex justify-start px-3 my-2" (click)="duplicateDeal(index)"> <!--(click)="duplicateDeal(index)"-->
                  <img src="../../../../assets/media/icons/Dublicate.svg" class="mt-1 mr-2">
                  <span class="text-sm text-gray-600">Duplicate</span>
                </button>
                <!-- <button (click)="deleteDeal(event.id)" ngbDropdownItem>Delete</button> -->
              </div>
            </div>
            <button [ngClass]="event.subDeals?.length == 0 || event.subDeals == [] ? 'cursor-not-allowed': 'cursor-pointer'" [disabled]="event.subDeals?.length == 0 || event.subDeals == []" (click)="event.isCollapsed = !event.isCollapsed">
              <i [ngClass]="!event.isCollapsed ? 'fas fa-chevron-down fa-sm p-1.5': 'fas fa-chevron-up fa-sm p-1.5'" class="bg-gray-100 rounded-md"></i>
            </button>
          </td>
        </tr>
        <div [ngClass]="index == 6 ? 'hidden': 'block'" id="borderMain"></div>
        <tr [@slideInOut] *ngIf="event.isCollapsed == true" class="z-0 w-full text-center bg-white">
          <td colspan="12">
              <table class="p-4 rounded-lg" style="width: 97.5%; margin-left: auto; margin-right: auto; margin-bottom: 12px; background-color: rgb(226 237 254);">
                <thead class="relative">
                  <tr class="rounded-lg" style="color:#545A60;">
                    <th class="py-4 text-sm font-semibold text-left pl-11" style="width: 350px; max-width: 350px;">Voucher</th>
                    <th class="py-4 text-sm font-semibold text-left" style="width: 9.375rem; max-width: 9.375rem;">Sold</th>
                    <th class="py-4 text-sm font-semibold text-left" style="width: 9.375rem; max-width: 9.375rem;">Available</th>
                    <th class="py-4 text-sm font-semibold text-right pr-28" style="width: 7.5rem; max-width: 7.5rem;">Value</th>
                    <th class="py-4 text-sm font-semibold text-left" style="width: 7.5rem; max-width: 7.5rem;">Total sold</th>
                    <th class="py-4 text-sm font-semibold text-left" style="width: 7.5rem; max-width: 7.5rem;">Net earnings</th>
                  </tr>
                  <div id="borderBottom"></div>
                </thead>
                <tbody class="relative">
                  <ng-container *ngFor="let voucher of event?.subDeals; let i = index; let first = first; let last = last">
                  <tr class="text-gray-600 rounded-lg">
                    <td class="py-4 text-sm text-left pl-11">
                      <span class="cursor-pointer" *ngIf="voucher?.title.length >= 24" [ngbTooltip]="voucher?.title" placement="top" [container]="'body'">
                        {{(voucher?.title?.length > 24) ? ((voucher.title) | slice:0:24)+'...':(voucher.title)}}
                      </span>
                      <span *ngIf="voucher?.title.length < 24">
                        {{(voucher?.title?.length > 24) ? ((voucher.title) | slice:0:24)+'...':(voucher.title)}}
                      </span>
                    </td>
                    <td class="py-4 text-sm text-left">{{voucher?.soldVouchers}}</td>
                    <td class="py-4 text-sm text-left">{{voucher?.numberOfVouchers}}</td>
                    <td class="py-4 text-sm text-right pr-28" style="width: 7.5rem;">{{voucher?.dealPrice.toFixed(2).replace('.', ',')}}&nbsp;&euro;</td>
                    <td class="py-4 text-sm text-right" style="width: 7.5rem; padding-right: 3.25rem;">{{voucher?.grossEarning.toFixed(2).replace('.', ',')}}&nbsp;&euro;</td>
                    <td class="py-4 text-sm text-right" style="width: 7.5rem; padding-right: 1.875rem;">{{voucher?.netEarning.toFixed(2).replace('.', ',')}}&nbsp;&euro;</td> <!--ye wala-->
                    <td class="py-4 xl:pl-2 1.5xl:pl-4 2xl:pl-12 text-sm text-left w-28">
                      <img class="text-sm cursor-pointer" src="../../../../assets/media/icons/edit.svg">
                    </td>
                  </tr> <!--(click)="openNew(index, i)"-->
                  <div id="borderBottom"></div>
                  <tr *ngIf="last" class="w-full">
                    <td colspan="12">
                      <ng-container *ngIf="event.startDate && event.endDate">
                        <tr class="w-full text-sm text-left text-gray-500">
                          <td class="py-4 pr-4 pl-11">Published from &nbsp;<span class="text-black">{{event?.startDate | date: 'dd-MM-yyyy'}} until {{event?.endDate | date: 'dd-MM-yyyy'}}</span></td>
                          <ng-container *ngIf="voucher?.voucherStartDate && voucher?.voucherEndDate">
                            <td class="px-4 py-4">Validity date &nbsp;<span class="text-black">{{voucher?.voucherEndDate | date: 'dd-MM-yyyy'}}</span></td>
                          </ng-container>
                          <ng-container *ngIf="voucher?.voucherValidity">
                            <td class="px-4 py-4">Voucher is valid for &nbsp;<span class="text-black">{{voucher?.voucherValidity}}</span>&nbsp; days</td>
                          </ng-container>
                        </tr>
                      </ng-container>
                    </td>
                  </tr>
                </ng-container>
                </tbody>
              </table>
          </td>
        </tr>
       </ng-container>

       <ng-container *ngIf="currentEvents.length == 0">
        <tr class="w-full text-center">
          <td colspan="8" class="w-full pt-12 text-xl font-semibold text-gray-700">
            No Record Found
          </td>
        </tr>
        <tr class="w-full text-center">
          <td colspan="8" class="w-full py-3 text-gray-600">
            It seems we can't find any results.
          </td>
        </tr>
      </ng-container>
    </table>
    <!-- <div class="flex justify-end px-5 pb-2 pt-14">
      <ngb-pagination
      [(page)]="page"
      [pageSize]="limit"
      [collectionSize]="dealData?.totalCount"
      [maxSize]="5" [boundaryLinks]="false" (pageChange)="next()">
    </ngb-pagination>
    </div> -->
  </div>
</ng-container>

<!-- <button class="p-2 bg-red-400" (click)="openNew()">Test</button> -->


<app-reusable-modal #modal [modalConfig]="modalConfig" style="z-index: -1!important;">
  <div class="mt-12 text-center">
    <h1>Setup a new Password</h1>
  </div>
  <form [formGroup]="newPassForm">
    <div class="flex flex-col items-center justify-center modal-body">
      <div class="w-3/4 mb-3 form-group">
        <label class="mb-3">Password</label>
        <div class="flex flex-row input-group-prepend justify-evenly">
         <span class="absolute flex items-center mt-3 cursor-pointer right-24" (click)="passwordShowHide()"><i [ngClass]="passwordHide ? 'far fa-eye': 'far fa-eye-slash'" class="p-2 ml-2 text-gray-600 bg-white rounded far fa-eye"></i></span>
         <input
          tabindex="-1"
          class="pr-20 form-control"
          type="{{passwordHide ? 'password' : 'text'}}"
          name="password"
          autocomplete="off"
          formControlName="password"
          [ngbPopover]="popContent"
          [popoverTitle]="popTitle"
          placement="bottom-right"
          triggers="manual"
          #popover="ngbPopover"
          (click)="openPopover(popover)"
          (keyup)="closePopover(newPassForm.controls['password'].valid, popover)"
          >
        </div>
        <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
          validation: 'required',
          message: 'Password is required',
          control: newPassForm.controls['password']}">
        </ng-container>

        <ng-container
        *ngIf="
        newPassForm.controls['password'].errors &&
        newPassForm.controls['password'].errors['ConfirmPassword']">
        <div class="fv-plugins-message-container">
          <div class="text-xs fv-help-block">
            Passswords do not match.
          </div>
        </div>
      </ng-container>

        <ng-template #popTitle>
          <div class="">Password should include:</div>
        </ng-template>
        <ng-template #popContent>
          <div class="flex flex-col justify-evenly">
            <div [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('minlength')  ? 'text-danger' : 'text-success'" class="text-left"><i class="pr-2" [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('minlength')  ? 'far fa-times-circle fa-sm text-danger' : 'far fa-check-circle fa-sm text-success'"></i>min. 8 characters</div>
            <div [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('hasCapitalCase')  ? 'text-danger' : 'text-success'" class="text-left"><i class="pr-2" [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('hasCapitalCase')  ? 'far fa-times-circle fa-sm text-danger' : 'far fa-check-circle fa-sm text-success'"></i>min. one uppercase</div>
            <div [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('hasSmallCase')  ? 'text-danger' : 'text-success'" class="text-left"><i class="pr-2" [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('hasSmallCase')  ? 'far fa-times-circle fa-sm text-danger' : 'far fa-check-circle fa-sm text-success'"></i>min. one lowercase</div>
            <div [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('hasNumber')  ? 'text-danger' : 'text-success'" class="text-left"><i class="pr-2" [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('hasNumber')  ? 'far fa-times-circle fa-sm text-danger' : 'far fa-check-circle fa-sm text-success'"></i>min. one numeric</div>
            <div [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('hasSpecialCharacters')  ? 'text-danger' : 'text-success'" class="text-left"><i class="pr-2" [ngClass]="newPassForm.controls['password']?.hasError('required') || newPassForm.controls['password']?.hasError('hasSpecialCharacters')  ? 'far fa-times-circle fa-sm text-danger' : 'far fa-check-circle fa-sm text-success'"></i>min. one special character (@,*,#,$,%,&)</div>
          </div>
          <div *ngIf="newPassForm.controls['password']?.valid" class="mt-2 text-sm text-left text-success">Password is valid</div>
        </ng-template>
       </div>

       <div class="w-3/4 mb-3 form-group">
        <label class="mb-3">Confirm Password</label>
        <div class="flex flex-row input-group-prepend justify-evenly">
          <span class="absolute flex items-center mt-3 cursor-pointer right-24" (click)="passwordShowHide()"><i [ngClass]="passwordHide ? 'far fa-eye': 'far fa-eye-slash'" class="p-2 ml-2 text-gray-600 bg-white rounded far fa-eye"></i></span>
          <input
            tabindex="-1"
            type="{{passwordHide ? 'password' : 'text'}}"
            formControlName="confirmPass"
            name="confirmPass"
            class="pr-20 form-control">
         </div>
         <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
          validation: 'required',
          message: 'Confirm your password',
          control: newPassForm.controls['confirmPass']}">
        </ng-container>
        <ng-container
        *ngIf="
        newPassForm.controls['confirmPass'].errors &&
        newPassForm.controls['confirmPass'].errors['ConfirmPassword']">
        <div class="fv-plugins-message-container">
          <div class="text-xs fv-help-block">
            Passswords do not match.
          </div>
        </div>
      </ng-container>
       </div>
    </div>
  </form>

  <div class="flex justify-center mb-8">
    <button [ngClass]="newPassForm.invalid ? 'opacity-50': ''" [disabled]="newPassForm.invalid" (click)="resetPassword(); closeModal()" class="px-10 py-2 text-white bg-blue-500 rounded-md">Save</button>
  </div>
</app-reusable-modal>

<ng-template #formError let-control="control" let-message="message" let-validation="validation">
  <ng-container *ngIf="control.hasError(validation) && (control.dirty || control.touched)">
    <div class="fv-plugins-message-container">
      <div class="text-xs fv-help-block">
        {{ message }}
      </div>
    </div>
  </ng-container>
</ng-template>

<app-media-progress></app-media-progress>
<!--<span class="mt-2.5 ml-1 absolute flex items-center"><i class="p-2 ml-2 text-white rounded fas fa-euro-sign fa-lg bg-success"></i></span>-->
