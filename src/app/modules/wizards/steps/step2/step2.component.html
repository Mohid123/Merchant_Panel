<app-vertical></app-vertical>

<!--Card for Viewing Deal-->
<div class="flex flex-col-reverse w-full gap-2 main-con md:h-136 md:flex-row">
  <div class="w-full p-6 overflow-y-auto shadow-sm md:p-4 xl:p-6 add-voucher card card-custom">
    <div class="flex flex-col self-center w-full p-0 modal-body max-w-135">
      <!--Title/ Header-->
        <div class="mb-9 lg:text-center">
          <h1 class="mt-1 mb-2.5 text-lg text-center md:text-xl xl:text-2xxl xl:font-semibold 2xl:text-3xl 3xl:text-4xl text-black">Let's create your sub deals.</h1>
          <div class="text-xs font-medium text-center text-primary-400 md:text-sm xl:text-base">Now is the time to set up the variations of the deal you're offering.</div>
        </div>
      <div>
        <div class="flex flex-col 3xl:justify-evenly">
          <ng-container *ngIf="subDeals.length > 0">
            <div class="mt-5">
              <div class="voucher-container" *ngFor="let singleDeal of subDeals; let i = index">
                <div class="mb-3 text-base font-medium text-justify lg:text-base lg:justify-start">{{singleDeal?.title}}</div>
                <div class="mb-1.5 flex items-center">
                  <i style="font-size: 12px; line-height: 24px; color:#4E5970" class="fas fa-euro-sign"></i><i style="font-style: normal; font-weight: 500; color:#4E5970" class="ml-1 mr-3 text-base">{{singleDeal?.originalPrice}}</i>
                  <ng-container *ngIf="convertToInteger(singleDeal?.dealPrice) < convertToInteger(singleDeal?.originalPrice)">
                    <i style="font-size: 12px; color:#08A80D; line-height: 24px;" class="fas fa-euro-sign"></i><i style="font-style: normal; font-weight: 500; color: #08A80D;" class="ml-1 mr-3 text-base">{{singleDeal?.dealPrice}}</i>
                    <i style="font-style: normal;" class="text-sm font-semibold text-primary-400">{{singleDeal?.discountPercentage.toFixed(2).replace('.', ',')}}% off</i>
                  </ng-container>
                  <ng-container *ngIf="convertToInteger(singleDeal?.dealPrice) == convertToInteger(singleDeal?.originalPrice)">
                    <i style="font-size: 12px; color:#08A80D; line-height: 24px;" class="fas fa-euro-sign"></i><i style="font-style: normal; font-weight: 500; color: #08A80D;" class="ml-1 mr-3 text-base">{{singleDeal?.dealPrice}}</i>
                  </ng-container>
                </div>
                <div class="flex justify-between">
                  <div class="flex justify-between">
                    <p class="text-sm" style="color:#414950">
                      Number of available sub deals
                    </p>
                    <span class="bg-primary-50 font-semibold rounded-md ml-4 h-6 text-primary-400 text-xs px-2.5 py-1">
                      {{singleDeal?.numberOfVouchers}}
                    </span>
                  </div>
                  <div class="flex">
                    <i class="mr-2 fas fa-pencil-alt fa-xs rounded-circle action-btn"
                      (click)="edit(i)">
                    </i>
                    <i class="fas fa-trash fa-xs rounded-circle action-btn"
                      (click)="showDeletePopoup(i)">
                    </i>
                </div>
              </div>
              </div>
              <div class="flex items-end justify-center h-8 add-more-voucher">
                <a *ngIf="!addVoucher" class="cursor-pointer text-primery-400" (click)="addMoreVoucher()">+ Add an extra sub deal</a>
              </div>
              <svg *ngIf="subDeals.length > 0" width="100%" height="25px">
                <line height="0.5px" x1="0" y1="13" x2="100%" y2="13" style="stroke-dasharray: 6, 6;stroke: #9BB3C8;stroke-width: 0.5px;"></line>
             </svg>
            </div>
          </ng-container>
        </div>
        <form *ngIf="addVoucher || subDeals.length == 0" class="mt-4 form" [formGroup]="vouchers">
          <div class="h-24 fv-row 2xl:h-26">
            <label class="form-label">Sub deal title</label>
              <input maxlength="140" appTrim type="text" class="form-control" formControlName="title" name="title"
              [ngClass]="{
              'is-invalid': vouchers.controls['title']?.invalid && vouchers.controls['title']?.touched,
              'is-valid': vouchers.controls['title']?.valid}">
            <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
              validation: 'required',
              message: 'Sub deal title is required',
              control: vouchers.controls['title']
              }">
            </ng-container>
            <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
              validation: 'pattern',
              message: 'Special characters are not allowed',
              control: vouchers.controls['title']
              }">
            </ng-container>
          </div>

          <div class="h-24 fv-row 2xl:h-26">
            <label class="form-label">Original price</label>
              <span class="absolute flex items-center h-11 "><i style="font-size:12px;" class="px-2.5 py-2 xl:mt-1.5 2xl:mt-2 ml-2 text-white bg-gray-500 rounded fas fa-euro-sign fa-lg"></i></span>
              <input appAllowTwoDecimal type="text" class="pl-12 form-control" formControlName="originalPrice"
              [ngClass]="{
              'is-invalid':  vouchers.controls['originalPrice']?.invalid &&  vouchers.controls['originalPrice']?.touched,
              'is-valid':  vouchers.controls['originalPrice']?.valid}">
              <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
                validation: 'required',
                message: 'Original Price is required',
                control: vouchers.controls['originalPrice']
              }">
              </ng-container>
              <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
                validation: 'pattern',
                message: 'Special characters/alphabets are not allowed',
                control: vouchers.controls['originalPrice']
              }">
              </ng-container>
            </div>

            <div class="h-24 fv-row 2xl:h-26">
            <label class="form-label">Deal price</label>
              <span class="absolute flex items-center h-11"><i style="font-size:12px;" class="px-2.5 py-2 ml-2 xl:mt-1.5 2xl:mt-2 text-white rounded fas fa-euro-sign fa-lg bg-success"></i></span>
              <input appAllowTwoDecimal type="text" class="pl-12 form-control" formControlName="dealPrice" name="dealPrice"
              [ngClass]="{
                'is-invalid': vouchers.controls['dealPrice']?.invalid && vouchers.controls['dealPrice']?.touched,
                'is-valid': vouchers.controls['dealPrice']?.valid && vouchers.controls['dealPrice']?.value != '' && vouchers.controls['dealPrice']?.value != null}">
                <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
                  validation: 'pattern',
                  message: 'Special characters/alphabets are not allowed',
                  control: vouchers.controls['dealPrice']
                }">
                </ng-container>
                <div class="text-xs text-danger"
                *ngIf="vouchers.controls['dealPrice']?.errors?.['confirmedValidator']">
                The deal price cannot be greater than the original price
              </div>
            </div>

            <div class="h-24 mb-3 fv-row 2xl:h-26">
            <label class="form-label">Number of available sub deals</label>
              <div class="flex items-center mb-1.5 justify-between h-8 border-2 border-white rounded-sm w-28">
                <button class="w-6 h-6 text-gray-500 bg-gray-200 rounded-md hover:text-primary-500 hover:bg-primary-100" (click)="handleMinus()">-</button>
                <input maxlength="4" appNumbersOnly type="text" style="height: 24px !important;min-height: unset;" class="w-12 py-0.5 px-0 text-xs text-center rounded-md form-control" placeholder="0" formControlName="numberOfVouchers" name="numberOfVouchers">
                <button class="w-6 h-6 text-gray-500 bg-gray-200 rounded-md hover:text-primary-500 hover:bg-primary-100" (click)="handlePlus()">+</button>
              </div>
              <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
                validation: 'required',
                message: 'Please specify number of vouchers',
                control: vouchers.controls['numberOfVouchers']
              }">
            </ng-container>
            <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
              validation: 'min',
              message: 'Please specify number of vouchers',
              control: vouchers.controls['numberOfVouchers']
            }">
          </ng-container>
          <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
            validation: 'pattern',
            message: 'Special characters/alphabets are not allowed',
            control: vouchers.controls['numberOfVouchers']
          }">
          </ng-container>
            <svg *ngIf="subDeals.length == 0" width="100%" height="25px">
              <line height="0.5px" x1="0" y1="13" x2="100%" y2="13" style="stroke-dasharray: 6, 6;stroke: #9BB3C8;stroke-width: 0.5px;"></line>
           </svg>
          </div>
          <div class="flex justify-between">
            <button [ngClass]="connection.isSaving.value == true ? 'opacity-50 cursor-not-allowed': 'opacity-100'" [disabled]="connection.isSaving.value == true" *ngIf="subDeals.length == 0 " type="button" class="self-center w-24 h-10 p-0 text-sm text-gray-600 bg-gray-300 rounded-lg" (click)="returnToPrevious()">Back</button>
            <button *ngIf="subDeals.length > 0 " type="button" class="self-center w-24 h-10 p-0 text-sm text-gray-600 bg-gray-300 rounded-lg" (click)="cancleVoucher()">Cancel</button>
            <button type="button" class="self-center w-24 h-10 p-0 text-white rounded-lg bg-primary-400" (click)="calculateDiscount()">Add</button>
          </div>

        </form>
        <div *ngIf="!addVoucher" class="flex justify-between mt-8 min-h-14 2xl:h-20">
          <button [ngClass]="connection.isSaving.value == true ? 'opacity-50 cursor-not-allowed': 'opacity-100'" [disabled]="connection.isSaving.value == true" (click)="returnToPrevious()" class="self-center w-24 h-10 text-sm text-gray-600 bg-gray-300 rounded-lg">Back</button>
          <button [disabled]="subDeals.length == 0" (click)="saveSecondDraft()" class="self-center w-32 h-10 text-sm text-white rounded-lg bg-primary-400">Save & next</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!--Edit Deal Modal-->

<app-reusable-modal #modal [modalConfig]="modalConfig">
  <div class="p-0 modal-body">
    <div class="flex justify-end p-0 m-0">
      <button class="p-3 m-2 btn btn-sm btn-icon btn-bg-light btn-active-color-primary" (click)="closeModal()" style="
       border-radius: 100%;">
        <span class="text-gray-800 fs-6">x</span>
      </button>
    </div>
    <div>
      <form class="px-6 mt-2 md:px-11 form" [formGroup]="editVouchers">
        <div class="h-24 fv-row 2xl:h-26">
          <label class="form-label">Sub deal title</label>
            <input maxlength="140" appTrim type="text" class="form-control" formControlName="title" name="title"
            [ngClass]="{
            'is-invalid': editVouchers.controls['title']?.invalid && editVouchers.controls['title']?.touched,
            'is-valid': editVouchers.controls['title']?.valid}">
          <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
            validation: 'required',
            message: 'Sub deal title is required',
            control: editVouchers.controls['title']
          }">
        </ng-container>
        <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
          validation: 'pattern',
          message: 'Special characters are not allowed',
          control: editVouchers.controls['title']
        }">
      </ng-container>
        </div>

        <div class="h-24 fv-row 2xl:h-26">
          <label class="form-label">Original price</label>
            <span class="absolute flex items-center h-11 "><i style="font-size:12px;" class="px-2.5 py-2 ml-2 xl:mt-1.5 2xl:mt-2 text-white bg-gray-500 rounded fas fa-euro-sign fa-lg"></i></span>
            <input appAllowTwoDecimal type="text" class="pl-12 form-control" formControlName="originalPrice"
            [ngClass]="{
            'is-invalid': editVouchers.controls['originalPrice']?.invalid && editVouchers.controls['originalPrice']?.touched,
            'is-valid':  editVouchers.controls['originalPrice']?.valid}">
            <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
              validation: 'required',
              message: 'Original Price is required',
              control: editVouchers.controls['originalPrice']
            }">
            </ng-container>
            <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
              validation: 'pattern',
              message: 'Special characters/alphabets are not allowed',
              control: editVouchers.controls['originalPrice']}">
            </ng-container>
          </div>

          <div class="h-24 fv-row 2xl:h-26">
            <label class="form-label">Deal price</label>
              <span class="absolute flex items-center h-11"><i style="font-size:12px;" class="px-2.5 py-2 ml-2 xl:mt-1.5 2xl:mt-2 text-white rounded fas fa-euro-sign fa-lg bg-success"></i></span>
              <input appAllowTwoDecimal type="text" class="pl-12 form-control" formControlName="dealPrice" name="dealPrice"
              [ngClass]="{
                'is-invalid': editVouchers.controls['dealPrice']?.invalid && editVouchers.controls['dealPrice']?.touched,
                'is-valid': editVouchers.controls['dealPrice']?.valid && editVouchers.controls['dealPrice']?.value != '' && editVouchers.controls['dealPrice']?.value != null && editVouchers.controls['dealPrice']?.value != undefined}">
                <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
                  validation: 'pattern',
                  message: 'Special characters/alphabets are not allowed',
                  control: editVouchers.controls['dealPrice']}">
                </ng-container>
                <!--&& editVouchers.controls['dealPrice']?.value != '' && editVouchers.controls['dealPrice']?.value != null && editVouchers.controls['dealPrice']?.value != undefined-->
                <div class="text-xs text-danger"
                *ngIf="editVouchers.controls['dealPrice']?.errors?.['confirmedValidator']">
                The deal price cannot be greater than the original price
              </div>
            </div>

          <div class="h-24 fv-row 2xl:h-26">
          <label class="form-label">Number of available sub deals</label>
            <div class="flex items-center justify-between h-8 border-2 border-white rounded-sm w-28">
              <button class="w-6 h-6 text-gray-500 bg-gray-200 rounded-md hover:text-primary-500 hover:bg-primary-100" (click)="editHandleMinus()">-</button>
              <input maxlength="4" appNumbersOnly type="text" style="height: 24px !important;min-height: unset;" class="w-12 py-0.5 px-0 text-xs text-center rounded-md form-control" placeholder="0" formControlName="numberOfVouchers" name="numberOfVouchers">
              <button class="w-6 h-6 text-gray-500 bg-gray-200 rounded-md hover:text-primary-500 hover:bg-primary-100" (click)="editHandlePlus()">+</button>
            </div>
            <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
              validation: 'required',
              message: 'Please specify number of sub deals',
              control: editVouchers.controls['numberOfVouchers']
            }">
          </ng-container>
          <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
            validation: 'min',
            message: 'Please specify number of sub deals',
            control: editVouchers.controls['numberOfVouchers']
          }">
        </ng-container>
        <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
          validation: 'pattern',
          message: 'Special characters/alphabets are not allowed',
          control: editVouchers.controls['numberOfVouchers']
        }">
      </ng-container>
          <svg *ngIf="subDeals.length == 0" width="100%" height="25px">
            <line height="0.5px" x1="0" y1="13" x2="100%" y2="13" style="stroke-dasharray: 6, 6;stroke: #9BB3C8;stroke-width: 0.5px;"></line>
         </svg>
        </div>
      </form>
    </div>
  </div>

  <div class="border-none modal-footer">
    <button type="button" class="self-center w-24 h-10 text-sm text-white rounded-lg bg-primary-400" (click)="editVoucher()">Save</button>
  </div>
</app-reusable-modal>

<app-reusable-modal #modal2 [modalConfig]="modalConfig">
  <div class="relative modal-header">
    <img src="../../../../../assets/media/icons/cross-modal.svg" class="absolute w-12 h-12 left-56 -top-7">
  </div>
  <div class="p-6 text-center modal-body">
    <div class="flex flex-col">
      <span class="mb-8">Are you sure you want to delete this sub deal?</span>
      <div class="flex justify-evenly">
        <button (click)="deleteDeal()" class="px-8 py-2 text-white bg-gray-900 rounded-md">Yes</button>
        <button (click)="closeSecondModal()" class="px-8 py-2 text-gray-600 bg-gray-300 rounded-md">Cancel</button>
      </div>
    </div>
  </div>
</app-reusable-modal>


<ng-template #formError let-control="control" let-message="message" let-validation="validation">
  <ng-container *ngIf="control?.hasError(validation) && (control.dirty || control.touched)">
    <div class="fv-plugins-message-container">
      <div class="text-xs fv-help-block">
        {{ message }}
      </div>
    </div>
  </ng-container>
</ng-template>

<app-media-progress></app-media-progress>
